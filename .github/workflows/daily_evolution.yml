name: Daily Evolution & Milestone Creation

on:
  schedule:
    - cron: '0 9 * * *' # runs every day at 9 AM UTC
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest

    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate daily evolution commit
        run: |
          echo "ðŸ“ˆ Daily code evolution at $(date)" >> evolution_log.txt
          echo "Minor tweaks to improve resilience and observability." >> evolution_log.txt
          git add evolution_log.txt
          git commit -m "chore: evolve platform $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Install GitHub CLI
        run: |
          sudo apt-get install -y gh
          echo "${GH_PAT}" | gh auth login --with-token

      - name: Create next milestone and issues
        run: |
          # Define next milestone
          MILESTONE_TITLE="Next Evolution $(date +'%Y-%m-%d')"
          gh api repos/${REPO}/milestones -f title="$MILESTONE_TITLE" -f state="open"

          # Define issues for next phase
          ISSUES=("Add alerting system" "Implement API latency monitor" "Integrate WebSocket live metrics" "Add user-facing uptime dashboard")
          
          for ISSUE in "${ISSUES[@]}"; do
            gh issue create \
              --repo "${REPO}" \
              --title "${ISSUE}" \
              --body "Part of ${MILESTONE_TITLE}. Automatically created during daily evolution." \
              --milestone "${MILESTONE_TITLE}" \
              --label "enhancement"
          done
